#!/usr/bin/env Rscript

# scripts/07_2_module_results.R
# Generate Figure 2 AB: Clustering method comparison for Enrichment and Aerosolization.
# Uses summary data generated by scripts/05_3_clustering_method_selection.R

packages <- c("tidyverse", "gridExtra", "grid", "ggsci")
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages)) install.packages(new_packages)

library(tidyverse)
library(gridExtra)
library(grid)
library(ggsci)

# --- Configuration ---
input_dir <- "reports/05_clustering_comparison"
figure_dir <- "figures"
report_dir <- "reports/07_module_results"

if (!dir.exists(input_dir)) {
    # Fallback if running from scripts directory
    input_dir <- "../reports/05_clustering_comparison"
}
if (!dir.exists(figure_dir)) dir.create(figure_dir, recursive = TRUE)
if (!dir.exists(report_dir)) dir.create(report_dir, recursive = TRUE)

# Files to process
files <- list(
    enrichment = file.path(input_dir, "comparison_summary_enrichment.csv"),
    aerosolization = file.path(input_dir, "comparison_summary_aerosolization.csv")
)

# Theme from 07_1 for consistency
theme_nature <- function(base_size = 12) {
    theme_classic(base_size = base_size) +
        theme(
            plot.title = element_text(face = "bold", size = base_size + 2, hjust = 0),
            axis.text = element_text(color = "black"),
            axis.title = element_text(color = "black"),
            axis.line = element_line(color = "black"),
            axis.ticks = element_line(color = "black"),
            panel.grid = element_blank(),
            legend.title = element_text(face = "bold"),
            legend.text = element_text(color = "black")
        )
}

# --- Color Palettes ---
# Matching Figure 6B / NPG style
# Enrichment (Blues)
pal_enrich <- c(
    "K-Means" = "#3C5488FF", # Main blue
    "CLARA" = "#E64B35FF",   # Lighter blue/cyan
    "HC-Ward" = "#00A087FF"  # Grey-blue
)

# Aerosolization (Reds)
pal_aero <- c(
    "K-Means" = "#3C5488FF", # Main red
    "CLARA" = "#E64B35FF",   # Lighter red/orange
    "HC-Ward" = "#00A087FF"  # Dark red
)

# Function to generate plot
generate_plot <- function(file_path, title_prefix, palette) {
    if (!file.exists(file_path)) {
        warning(paste("File not found:", file_path))
        return(NULL)
    }

    df <- read_csv(file_path, show_col_types = FALSE)

    p <- ggplot(df, aes(x = k, y = mean_sil, color = Method, group = Method)) +
        geom_line(linewidth = 1) +
        geom_point(size = 2) +
        geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2, alpha = 0.6) +
        theme_nature(base_size = 14) +
        scale_color_manual(values = palette) +
        labs(
            title = title_prefix,
            y = "Avg Silhouette Width",
            x = "Number of Clusters (k)"
        ) +
        theme(
            legend.position = "bottom"
        ) +
        scale_x_continuous(breaks = unique(df$k))

    return(p)
}

# --- Module Analysis Functions ---

analyze_module <- function(label, result_file, feature_file, csv_dir, plot_dir) {
    message("\nanalyzing module: ", label)

    if (!file.exists(result_file) || !file.exists(feature_file)) {
        warning("Missing files for ", label)
        return(NULL)
    }

    # Load data
    clusters <- read_csv(result_file, show_col_types = FALSE) %>%
        mutate(cluster = as.character(cluster))
    features <- read_csv(feature_file, show_col_types = FALSE)

    # Merge
    df_merged <- inner_join(clusters, features, by = "molecule_id")

    # --- 1. Clustering Outcome ---
    # Parse parent vs sub-clusters
    # Logic: if cluster has "_", it's a split. "1_1" -> parent "1".
    df_outcome <- clusters %>%
        mutate(
            is_split = grepl("_", cluster),
            parent = if_else(is_split, sub("_[0-9]+$", "", cluster), cluster)
        )

    parent_counts <- df_outcome %>%
        group_by(parent) %>%
        summarise(
            n_sub = n_distinct(cluster),
            n_compounds = n(),
            is_split = any(is_split),
            .groups = "drop"
        )

    splits_summary <- parent_counts %>%
        filter(is_split) %>%
        select(parent, n_sub)

    # Cluster Sizes
    cluster_sizes <- df_merged %>%
        count(cluster, name = "n") %>%
        arrange(desc(n))

    message("  Final clusters: ", nrow(cluster_sizes))
    message("  Split parents: ", nrow(splits_summary))
    if (nrow(splits_summary) > 0) {
        print(splits_summary)
    }

    # Save Stats
    write_csv(cluster_sizes, file.path(csv_dir, paste0("cluster_sizes_", label, ".csv")))
    write_csv(splits_summary, file.path(csv_dir, paste0("cluster_splits_", label, ".csv")))

    # --- 2. Fingerprints (Median Z-scores) ---
    feature_cols <- setdiff(names(features), "molecule_id")

    # Calculate medians
    fingerprints <- df_merged %>%
        group_by(cluster) %>%
        summarise(across(all_of(feature_cols), median, .names = "{.col}"), .groups = "drop")

    fingerprint_file <- file.path(csv_dir, paste0("cluster_fingerprints_", label, ".csv"))
    write_csv(fingerprints, fingerprint_file)

    # Generate Heatmap
    # Reshape for plotting
    fp_long <- fingerprints %>%
        pivot_longer(cols = -cluster, names_to = "Descriptor", values_to = "Z_Score")

    # Order clusters? Maybe strict numeric/alphanumeric sort
    # "1", "10", "2" -> "1", "2", ... "10"
    # Handling "1_1" vs "1" is tricky. Mixed sort.
    # Simple approach: str_sort from stringr (in tidyverse)
    fp_long$cluster <- factor(fp_long$cluster, levels = stringr::str_sort(unique(fp_long$cluster), numeric = TRUE))

    p_heat <- ggplot(fp_long, aes(x = Descriptor, y = cluster, fill = Z_Score)) +
        geom_tile(color = "white", linewidth = 0.2) +
        scale_fill_gradient2(
            low = "#3C5488FF", mid = "white", high = "#E64B35FF",
            midpoint = 0, name = "Median Z-Score"
        ) +
        theme_nature(base_size = 12) +
        labs(
            title = paste0("Cluster Fingerprints: ", label),
            x = NULL, y = "Cluster ID"
        ) +
        theme(
            axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
            panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
        )

    # Save Heatmap to Figures? No, we will combine them later.
    # But useful to keep the plot object.

    return(list(sizes = cluster_sizes, fingerprints = fingerprints, plot = p_heat))
}

# --- Generate Plots ---

# Plot A: Enrichment
p_enrichment <- generate_plot(files$enrichment, "A. Clustering Performance: Enrichment", pal_enrich)

# Plot B: Aerosolization
p_aerosolization <- generate_plot(files$aerosolization, "B. Clustering Performance: Aerosolization", pal_aero)

# --- Combine and Save Figure 2 AB ---

if (!is.null(p_enrichment) && !is.null(p_aerosolization)) {
    # Arrange in a grid: 1 column, 2 rows (or 2 cols, 1 row? Usually AB are side by side if landscape, or top-down if portrait)
    # "Figure 2 AB" usually suggests side-by-side or top-down.
    # Given the x-axis is "k" which can be wide, side-by-side might be squeezed if k is large.
    # But k is 3..50, so side-by-side is fine for landscape.

    plot_file <- file.path(figure_dir, "Figure_2_AB.png")

    # Use grid.arrange to save
    # We can capture the grob
    g <- arrangeGrob(p_enrichment, p_aerosolization, ncol = 2)

    ggsave(plot_file, g, width = 16, height = 6, dpi = 300)
    message("Saved Figure 2 AB to: ", plot_file)
} else {
    message("Could not generate both plots. Checking files:")
    print(files)
}

# --- Generate Final Outcome & Fingerprints ---
data_dir <- "data/processed/05_clustering" # where results are

# Enrichment
res_enrich <- analyze_module(
    "enrichment",
    file.path(data_dir, "clustering_results_enrichment.csv"),
    file.path(data_dir, "transformed_clustering_properties_enrichment.csv"),
    report_dir,
    figure_dir
)

# Aerosolization
res_aerosol <- analyze_module(
    "aerosolization",
    file.path(data_dir, "clustering_results_aerosolization.csv"),
    file.path(data_dir, "transformed_clustering_properties_aerosolization.csv"),
    report_dir,
    figure_dir
)

# --- Combine and Save Figure 3 AB (Fingerprints) ---

plot_heatmap <- function(fingerprints, title, z_limits, show_legend = TRUE) {
    fp_long <- fingerprints %>%
        pivot_longer(cols = -cluster, names_to = "Descriptor", values_to = "Z_Score")

    # Sort clusters naturally
    if ("cluster" %in% names(fp_long)) {
        fp_long$cluster <- factor(fp_long$cluster, levels = stringr::str_sort(unique(fp_long$cluster), numeric = TRUE))
    }

    p <- ggplot(fp_long, aes(x = Descriptor, y = cluster, fill = Z_Score)) +
        geom_tile(color = "white", linewidth = 0.2) +
        scale_fill_gradient2(
            low = "#3C5488FF", mid = "white", high = "#E64B35FF",
            midpoint = 0, name = "Median Z-Score",
            limits = z_limits, oob = scales::squish
        ) +
        theme_nature(base_size = 12) +
        labs(
            title = title,
            x = NULL, y = "Cluster ID"
        ) +
        theme(
            axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
            panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
        )

    if (!show_legend) {
        p <- p + theme(legend.position = "none")
    }

    return(p)
}

if (!is.null(res_enrich$fingerprints) && !is.null(res_aerosol$fingerprints)) {
    # 1. Determine Shared Color Scale Limits
    fp_enrich <- res_enrich$fingerprints
    fp_aerosol <- res_aerosol$fingerprints

    # Extract numerical data
    num_enrich <- fp_enrich %>% select(where(is.numeric))
    num_aerosol <- fp_aerosol %>% select(where(is.numeric))

    all_values <- c(as.matrix(num_enrich), as.matrix(num_aerosol))
    z_limits <- range(all_values, na.rm = TRUE)

    # 2. Generate Plots
    # Enrichment: No legend
    p1 <- plot_heatmap(fp_enrich, "A. Enrichment Fingerprints", z_limits, show_legend = FALSE)

    # Aerosolization: With legend
    p2 <- plot_heatmap(fp_aerosol, "B. Aerosolization Fingerprints", z_limits, show_legend = TRUE)

    # 3. Calculate Widths
    # Goal: Make heatmap columns (descriptors) same physical width.
    # Width ~ n_descriptors + constant_overhead

    n_desc_enrich <- ncol(num_enrich)
    n_desc_aerosol <- ncol(num_aerosol)

    # Constants (tuned roughly)
    # Axis labels width ~ 2-3 descriptors equivalent?
    # Legend width ~ 5-6 descriptors equivalent?
    overhead_base <- 1
    overhead_legend <- 2

    w_enrich <- n_desc_enrich + overhead_base
    w_aerosol <- n_desc_aerosol + overhead_base + overhead_legend

    g3 <- arrangeGrob(p1, p2, ncol = 2, widths = c(w_enrich, w_aerosol))

    plot_file_3 <- file.path(figure_dir, "Figure_3_AB.png")
    ggsave(plot_file_3, g3, width = 16, height = 9, dpi = 200)
    message("Saved Figure 3 AB to: ", plot_file_3)
}

message("Done.")
